<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="INSPIRO" />
    <meta name="description" content="Themeforest Template Polo, html template">
    <link rel="icon" type="image/png" href="images/favicon.png">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>MONETA | register</title>
    <link href="css/plugins.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <div class="body-inner">
        <div class="container-fluid">
            <div class="row min-vh-100">
                <div class="col-md-8 col-lg-7 d-flex align-items-center">
                    <div class="w-100 px-3 px-sm-5 py-xl-5 px-xl-7">
                        <h3>Register New Account</h3>
                        <!-- <p>Create an account by entering the information below. If you are a returning customer please login at the top of the page.</p> -->
                        <p>Biar aman isi aja data dummy</p>
                        <div id="alert-container"></div>

                        <form id="form1" class="form-validate mt-5">
                            <div class="h5 mb-4">Account details</div>
                            <div class="form-group">
                                <label for="username">Username</label>
                                <input type="text" class="form-control" name="username" placeholder="Enter username" required="">
                            </div>
                            <div class="form-group">
                                <label for="email">Email address</label>
                                <input type="email" class="form-control" name="email" placeholder="Enter your email" required="">
                            </div>
                            <div class="form-group">
                                <label for="password">Password</label>
                                <div class="input-group show-hide-password">
                                    <input class="form-control" name="password" placeholder="Enter password" type="password" required="">
                                    <span class="input-group-text"><i class="icon-eye-off" aria-hidden="true" style="cursor: pointer;"></i></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="confirm_password">Confirm Password</label>
                                <div class="input-group show-hide-password">
                                    <input class="form-control" name="confirm_password" placeholder="Enter Confirm password" type="password" required="">
                                    <span class="input-group-text"><i class="icon-eye-off" aria-hidden="true" style="cursor: pointer;"></i></span>
                                </div>
                            </div>
                            <button type="submit" id="btnSubmit" class="btn btn-primary mt-5">Submit</button>
                        </form>

                        <div class="mt-4">
                            <small>Already have an account?</small> 
                            <a href="login.html" class="small fw-bold">Sign in</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-5 d-none d-md-block bg-cover" style="background-image: url(images/top-view-woman-working-as-economist.jpg);">
                    <a href="index.html" class="btn btn-white btn-rounded-only btn-rounded position-absolute left-4 top-4" title="Go back Homepage"><i class="icon-home"></i></a>
                </div>
            </div>
        </div>
    </div>

    <script src="js/jquery.js"></script>
    <script src="js/plugins.js"></script>
    <script src="js/functions.js"></script>

 <script>
    const BASE_URL = 'https://worrkhiiwvlinanxsimn.supabase.co/rest/v1';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndvcnJraGlpd3ZsaW5hbnhzaW1uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNTEzOTIsImV4cCI6MjA4MjYyNzM5Mn0.vygEL8BYGK_UXPwMrvgpRkk7RVQQ5Q0AB1n5uk1IYi0';

    function showAlert(message, type = 'danger') {
        const container = document.getElementById('alert-container');
        container.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <span id="alert-message">${message}</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
    }

    document.getElementById('form1').addEventListener('submit', async function(e) {
        e.preventDefault();

        const form = e.target;
        const btnSubmit = document.getElementById('btnSubmit');
        const username = form.username.value;
        const email = form.email.value;
        const password = form.password.value;
        const confirm_password = form.confirm_password.value;

        // Validasi Client-side
        if (password.length < 8) {
            showAlert("Password minimal 8 karakter!");
            return;
        }
        if (/\s/.test(password)) {
            showAlert("Password tidak boleh mengandung spasi!");
            return;
        }
        if (password !== confirm_password) {
            showAlert("Password dan Confirm Password tidak sama!");
            return;
        }

        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';

        try {
            // --- LANGKAH 1: POST REGISTER USER ---
            const regResponse = await fetch(`${BASE_URL}/user`, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation' // Agar return data user baru (id)
                },
                body: JSON.stringify({ name: username, email: email, password: password })
            });

            const userData = await regResponse.json();

            if (regResponse.ok && userData.length > 0) {
                const newUserId = userData[0].id;

                // --- LANGKAH 2: GET SEMUA MENU ---
                const menuResponse = await fetch(`${BASE_URL}/menu?select=*`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                const allMenus = await menuResponse.json();

                // --- LANGKAH 3: PREPARE PAYLOAD MENU_USER ---
                const menuUserPayload = allMenus.map(menu => ({
                    user_id: newUserId,
                    menu_id: menu.id
                }));

                // --- LANGKAH 4: POST KE MENU_USER ---
                const assignResponse = await fetch(`${BASE_URL}/menu_user`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(menuUserPayload)
                });

                if (assignResponse.ok) {
                    form.reset();
                    let countdown = 10;
                    
                    const updateMessage = () => {
                        showAlert(
                            `Register & Setup Menu Berhasil! Mengalihkan ke login dalam <b>${countdown}</b> detik... atau <a href="login.html" class="alert-link">klik di sini</a>.`, 
                            'success'
                        );
                    };

                    updateMessage();
                    const timer = setInterval(() => {
                        countdown--;
                        if (countdown <= 0) {
                            clearInterval(timer);
                            window.location.href = 'login.html';
                        } else {
                            updateMessage();
                        }
                    }, 1000);
                } else {
                    showAlert("User terdaftar tapi gagal konfigurasi menu akses.");
                    btnSubmit.disabled = false;
                }

            } else {
                if (regResponse.status === 409) {
                    showAlert("Email sudah terdaftar!");
                } else {
                    showAlert("Register gagal. Silakan coba lagi.");
                }
                btnSubmit.disabled = false;
                btnSubmit.innerText = "Register account";
            }
        } catch (err) {
            console.error(err);
            showAlert("Terjadi error koneksi atau sistem.");
            btnSubmit.disabled = false;
            btnSubmit.innerText = "Register account";
        }
    });
</script>
</body>
</html>