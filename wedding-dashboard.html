<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Wedding Budget Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Inter, system-ui, sans-serif; background: #0f172a; color: #e5e7eb; margin: 0; padding: 24px; }
    h1 { font-size: 26px; margin-bottom: 4px; }
    .subtitle { color: #94a3b8; margin-bottom: 24px; }
    
    /* Stats & Grid Layout */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: #1e293b; padding: 16px; border-radius: 12px; border: 1px solid #334155; }
    .stat-label { color: #94a3b8; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; }
    .stat-value { font-size: 18px; font-weight: 700; margin-top: 4px; }
    .text-pria { color: #3b82f6; }
    .text-wanita { color: #ec4899; }
    .text-bersama { color: #10b981; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .card { background: #020617; border-radius: 14px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.4); }
    
    /* Table Responsive */
    .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 10px; }
    table { min-width: 650px; width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 12px 10px; border-bottom: 1px solid #1e293b; text-align: left; }
    th { color: #94a3b8; font-weight: 500; }
    td { white-space: nowrap; }
    td:first-child { white-space: normal; min-width: 150px; }

    /* UI Components */
    .category { margin-bottom: 30px; background: #111827; padding: 15px; border-radius: 10px; }
    .category h3 { margin: 0 0 15px 0; font-size: 18px; border-left: 4px solid #3b82f6; padding-left: 10px; }
    .badge { padding: 4px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; background: #1e293b; color: #cbd5e1; }
    .actions { display: flex; gap: 10px; margin-bottom: 20px; }
    
    button { cursor: pointer; border: none; font-weight: 600; transition: 0.2s; }
    .btn-primary { background: #3b82f6; color: white; padding: 10px 18px; border-radius: 8px; }
    .btn-primary:hover { background: #2563eb; }
    
    .btn-icon { background: transparent; color: #94a3b8; display: inline-flex; align-items: center; justify-content: center; padding: 6px; border-radius: 6px; }
    .btn-icon:hover { color: #f8fafc; background: rgba(255,255,255,0.05); transform: scale(1.1); }
    .btn-icon svg { width: 18px; height: 18px; }

    /* Modal */
    #modalOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal { background: #1e293b; padding: 24px; border-radius: 12px; width: 90%; max-width: 400px; }
    input, select { width: 100%; padding: 10px; margin: 8px 0 16px 0; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 6px; box-sizing: border-box; }
    label { font-size: 12px; color: #94a3b8; }
  </style>
</head>
<body>

<h1>Wedding Budget Dashboard</h1>
<div class="subtitle">Realtime management for our big day</div>

<div id="statsSummary" class="stats-grid"></div>

<div class="grid">
    <div class="card"><canvas id="partyChart"></canvas></div>
    <div class="card"><canvas id="compareChart"></canvas></div>
</div>

<div class="actions">
  <button class="btn-primary" onclick="openModal('category')">+ Kategori</button>
  <button class="btn-primary" onclick="openModal('item')">+ Item</button>
  <button class="btn-primary" onclick="openModal('payment')">+ Bayar</button>
</div>

<div class="card">
  <h3>Detail Kebutuhan</h3>
  <div id="categoryContainer"></div>
</div>

<div id="modalOverlay">
  <div class="modal">
    <h2 id="modalTitle" style="margin-top:0">Tambah Data</h2>
    <div id="formContainer"></div>
    <div style="display:flex; justify-content: flex-end; gap: 10px;">
        <button style="background:#475569; color:white; padding: 10px 18px; border-radius: 8px;" onclick="closeModal()">Batal</button>
        <button class="btn-primary" onclick="submitForm()">Simpan</button>
    </div>
  </div>
</div>

<script>
const API_BASE = 'https://worrkhiiwvlinanxsimn.supabase.co/rest/v1';
const HEADERS = {
  apikey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndvcnJraGlpd3ZsaW5hbnhzaW1uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNTEzOTIsImV4cCI6MjA4MjYyNzM5Mn0.vygEL8BYGK_UXPwMrvgpRkk7RVQQ5Q0AB1n5uk1IYi0',
  Authorization: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndvcnJraGlpd3ZsaW5hbnhzaW1uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNTEzOTIsImV4cCI6MjA4MjYyNzM5Mn0.vygEL8BYGK_UXPwMrvgpRkk7RVQQ5Q0AB1n5uk1IYi0',
  'Content-Type': 'application/json',
  'Prefer': 'return=representation'
};

let rawData = [];
let partyTotals = {};
let breakdown = {
  estimasi: { total: 0, pria: 0, wanita: 0, bersama: 0 },
  bayar: { total: 0, pria: 0, wanita: 0, bersama: 0 }
};
let charts = {};
let currentMode = '';
let editingId = null;

async function fetchData() {
  const res = await fetch(`${API_BASE}/wedding_categories?select=*,wedding_items(*,wedding_parties(*),wedding_payments(*))`, { headers: HEADERS });
  rawData = await res.json();
  processData();
  renderCharts();
  renderCategories();
}

function processData() {
  breakdown = {
    estimasi: { total: 0, pria: 0, wanita: 0, bersama: 0 },
    bayar: { total: 0, pria: 0, wanita: 0, bersama: 0 }
  };
  partyTotals = {};

  rawData.forEach(cat => {
    cat.wedding_items.forEach(item => {
      const est = item.estimated_cost || 0;
      const paid = item.wedding_payments.reduce((sum, p) => sum + p.paid_amount, 0);
      const partyId = parseInt(item.parties_id);
      const partyName = item.wedding_parties?.name || 'Unknown';

      breakdown.estimasi.total += est;
      breakdown.bayar.total += paid;

      if(partyId === 1) { breakdown.estimasi.pria += est; breakdown.bayar.pria += paid; }
      else if(partyId === 2) { breakdown.estimasi.wanita += est; breakdown.bayar.wanita += paid; }
      else { breakdown.estimasi.bersama += est; breakdown.bayar.bersama += paid; }
      
      partyTotals[partyName] = (partyTotals[partyName] || 0) + paid;
    });
  });
  renderStats();
}

function renderStats() {
  const fmt = (n) => 'Rp ' + n.toLocaleString('id-ID');
  document.getElementById('statsSummary').innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Total Anggaran</div>
      <div class="stat-value">${fmt(breakdown.estimasi.total)}</div>
      <div class="stat-label" style="margin-top:8px">Sisa: ${fmt(breakdown.estimasi.total - breakdown.bayar.total)}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Pria</div>
      <div class="stat-value text-pria">${fmt(breakdown.estimasi.pria)}</div>
      <div class="stat-label" style="margin-top:8px">Paid: ${fmt(breakdown.bayar.pria)}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Wanita</div>
      <div class="stat-value text-wanita">${fmt(breakdown.estimasi.wanita)}</div>
      <div class="stat-label" style="margin-top:8px">Paid: ${fmt(breakdown.bayar.wanita)}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Bersama</div>
      <div class="stat-value text-bersama">${fmt(breakdown.estimasi.bersama)}</div>
      <div class="stat-label" style="margin-top:8px">Paid: ${fmt(breakdown.bayar.bersama)}</div>
    </div>
  `;
}

function openModal(mode, id = null) {
  currentMode = mode;
  editingId = id;
  const container = document.getElementById('formContainer');
  document.getElementById('modalOverlay').style.display = 'flex';

  if (mode === 'category') {
    document.getElementById('modalTitle').innerText = "Tambah Kategori";
    container.innerHTML = `<label>Nama Kategori</label><input type="text" id="f_name">`;
  } else if (mode === 'item') {
    let item = null;
    if(id) rawData.forEach(c => c.wedding_items.forEach(i => { if(i.id == id) item = i; }));
    document.getElementById('modalTitle').innerText = id ? "Edit Item" : "Tambah Item";
    container.innerHTML = `
      <label>Kategori</label>
      <select id="f_cat">${rawData.map(c => `<option value="${c.id}" ${item?.category_id == c.id ? 'selected':''}>${c.name}</option>`).join('')}</select>
      <label>Nama Item</label><input type="text" id="f_name" value="${item?.name || ''}">
      <label>Estimasi Biaya</label><input type="number" id="f_cost" value="${item?.estimated_cost || ''}">
      <label>Link Source</label><input type="text" id="f_url" value="${item?.url_source || ''}">
      <label>Pihak</label>
      <select id="f_party">
        <option value="3" ${item?.parties_id == 3 ? 'selected':''}>Bersama</option>
        <option value="1" ${item?.parties_id == 1 ? 'selected':''}>Pihak Pria</option>
        <option value="2" ${item?.parties_id == 2 ? 'selected':''}>Pihak Wanita</option>
      </select>
    `;
  } else if (mode === 'payment') {
    document.getElementById('modalTitle').innerText = "Catat Pembayaran";
    let items = [];
    rawData.forEach(c => c.wedding_items.forEach(i => items.push(i)));
    container.innerHTML = `
      <label>Item</label><select id="f_item">${items.map(i => `<option value="${i.id}">${i.name}</option>`).join('')}</select>
      <label>Jumlah Bayar</label><input type="number" id="f_amount">
    `;
  }
}

async function submitForm() {
  let url = `${API_BASE}/wedding_categories`, method = 'POST', body = {};
  if (currentMode === 'category') {
    body = { name: document.getElementById('f_name').value };
  } else if (currentMode === 'item') {
    url = editingId ? `${API_BASE}/wedding_items?id=eq.${editingId}` : `${API_BASE}/wedding_items`;
    method = editingId ? 'PATCH' : 'POST';
    body = {
      category_id: parseInt(document.getElementById('f_cat').value),
      name: document.getElementById('f_name').value,
      estimated_cost: parseInt(document.getElementById('f_cost').value) || 0,
      parties_id: parseInt(document.getElementById('f_party').value),
      url_source: document.getElementById('f_url').value
    };
  } else if (currentMode === 'payment') {
    url = `${API_BASE}/wedding_payments`;
    body = { item_id: parseInt(document.getElementById('f_item').value), paid_amount: parseInt(document.getElementById('f_amount').value) };
  }

  const res = await fetch(url, { method, headers: HEADERS, body: JSON.stringify(body) });
  if (res.ok) { closeModal(); fetchData(); } else { alert("Gagal menyimpan data"); }
}

function renderCategories() {
  document.getElementById('categoryContainer').innerHTML = rawData.map(cat => `
    <div class="category">
      <h3>${cat.name}</h3>
      <div class="table-responsive">
        <table>
          <thead><tr><th>Item</th><th>Pihak</th><th>Estimasi</th><th>Terbayar</th><th style="text-align:center">Source</th><th style="text-align:center">Aksi</th></tr></thead>
          <tbody>
            ${cat.wedding_items.map(item => `
              <tr>
                <td><strong>${item.name}</strong></td>
                <td><span class="badge">${item.wedding_parties?.name || 'Bersama'}</span></td>
                <td>Rp ${item.estimated_cost?.toLocaleString('id-ID')}</td>
                <td>Rp ${item.wedding_payments.reduce((s,p)=>s+p.paid_amount,0).toLocaleString('id-ID')}</td>
                <td style="text-align:center">
                  ${item.url_source ? `<a href="${item.url_source}" target="_blank" class="btn-icon"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" stroke-width="2"/></svg></a>` : '-'}
                </td>
                <td style="text-align:center">
                  <button class="btn-icon" onclick="openModal('item', ${item.id})"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" stroke-width="2"/></svg></button>
                  <button class="btn-icon" onclick="deleteItem(${item.id})"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" stroke-width="2"/></svg></button>
                </td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `).join('');
}

function renderCharts() {
  if (charts.p) charts.p.destroy(); if (charts.c) charts.c.destroy(); if (charts.d) charts.d.destroy();
  
  charts.p = new Chart(document.getElementById('partyChart'), {
    type: 'doughnut',
    data: { labels: Object.keys(partyTotals), datasets: [{ data: Object.values(partyTotals), backgroundColor: ['#3b82f6', '#ec4899', '#10b981'] }] },
    options: { plugins: { title: { display: true, text: 'Realisasi Pembayaran (%)', color: '#fff' } } }
  });

  charts.c = new Chart(document.getElementById('compareChart'), {
    type: 'bar',
    data: { labels: ['Total'], datasets: [{ label: 'Estimasi', data: [breakdown.estimasi.total], backgroundColor: '#334155' }, { label: 'Terbayar', data: [breakdown.bayar.total], backgroundColor: '#10b981' }] },
    options: { scales: { y: { ticks: { color: '#94a3b8' } } } }
  });
}

async function deleteItem(id) {
  if (confirm("Hapus item ini?")) {
    const res = await fetch(`${API_BASE}/wedding_items?id=eq.${id}`, { method: 'DELETE', headers: HEADERS });
    if (res.ok) fetchData();
  }
}

function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
fetchData();
</script>
</body>
</html>